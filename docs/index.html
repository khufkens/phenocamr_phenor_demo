<!DOCTYPE html>
<html>
  <head>
    <title>phenocamr &amp; phenor tutorial</title>
    <meta charset="utf-8">
    <meta name="author" content="Koen Hufkens" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# phenocamr &amp; phenor tutorial
### Koen Hufkens
### last updated: 2018-11-28

---




background-image: url(https://upload.wikimedia.org/wikipedia/commons/b/b1/Two_toed_sloth.JPG)
background-position: 50% 50%
background-size: 100%
class: center, bottom, inverse

## modelling phenology the lazy way...

---
# phenocamr &amp; phenor

--

## - phenocamr: processing toolchain
  - post-processing of phenocam time series
  - generation of transition date (products)

--

## - phenor: modelling framework
  - data prepartion
  - model callibration
  - model predictions

---
# phenor data sources

- transition dates derived from [PhenoCam](https://phenocam.sr.unh.edu) time series
- MODIS MCD12Q2 phenology product using the [MODISTools R package](http://onlinelibrary.wiley.com/doi/10.1002/ece3.1273/full) (in flux)
- [Pan European Phenology data (PEP725)](http://www.pep725.eu/) 
- [USA National Phenological Network (USA-NPN)](https://www.usanpn.org/) 

---
# Loading the required packages


```r
# install.packages("devtools")
# install_github("khufkens/phenor")
# install.packages("phenocamr")
# install.packages("maps")

library("phenocamr")
library("phenor")
library("maps")
library("raster")
```

---
# Downloading offline demo data

You can download the presentation and demo files [as a zip file](https://github.com/khufkens/phenocamr_phenor_demo/archive/master.zip).

or clone the repository

``` bash
git clone https://github.com/khufkens/phenocamr_phenor_demo.git

```

Open the R markdown file of this presentation to explore the underlying code. The file is called `index.Rmd` and is located in `./docs/`.


---
# Downloading &amp; Processing PhenoCam data


```r
# The command below downloads all time series
# for deciduous broadleaf regions of interest
# at the bartlettir site
phenocamr::download_phenocam(
  frequency = 3,
  veg_type = "DB",
  roi_id = 1000,
  site = "bartlettir",
  phenophase = TRUE,
  out_dir = "../data/"
  )
```

```
## Downloading: bartlettir_DB_1000_3day.csv
```

```
## -- Flagging outliers!
```

```
## -- Smoothing time series!
```

```
## -- Estimating transition dates!
```

---
# Downloading &amp; Processing PhenoCam data


```r
# load the time series data
df &lt;- read.table(
  "../data/bartlettir_DB_1000_3day.csv",
  header = TRUE,
  sep = ","
  )

# read in the transition date file
td &lt;- read.table(
  "../data/bartlettir_DB_1000_3day_transition_dates.csv",
  header = TRUE,
  sep = ","
  )

# select the rising (spring dates) for 25% threshold of Gcc 90
td &lt;- td[td$direction == "rising" &amp; td$gcc_value == "gcc_90",]
```

---

# Downloading &amp; Processing PhenoCam data


```r
str(df)
```

```
## 'data.frame':	3346 obs. of  49 variables:
##  $ date                : Factor w/ 3346 levels "2008-01-20","2008-01-21",..: 1 2 3 4 5 6 7 8 9 10 ...
##  $ year                : int  2008 2008 2008 2008 2008 2008 2008 2008 2008 2008 ...
##  $ doy                 : int  20 21 22 23 24 25 26 27 28 29 ...
##  $ image_count         : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_filename     : Factor w/ 1035 levels "bartlettir_2008_04_19_120541.jpg",..: NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_r            : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_g            : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_b            : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_gcc          : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ midday_rcc          : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ r_mean              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ r_std               : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ g_mean              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ g_std               : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ b_mean              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ b_std               : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ gcc_mean            : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ gcc_std             : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ gcc_50              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ gcc_75              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ gcc_90              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ rcc_mean            : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ rcc_std             : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ rcc_50              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ rcc_75              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ rcc_90              : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ max_solar_elev      : num  NA NA NA NA NA NA NA NA NA NA ...
##  $ snow_flag           : logi  NA NA NA NA NA NA ...
##  $ outlierflag_gcc_mean: int  0 0 0 0 0 0 0 0 0 0 ...
##  $ outlierflag_gcc_50  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ outlierflag_gcc_75  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ outlierflag_gcc_90  : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ smooth_gcc_mean     : num  0.361 0.361 0.362 0.362 0.362 ...
##  $ smooth_gcc_50       : num  0.361 0.362 0.362 0.362 0.363 ...
##  $ smooth_gcc_75       : num  0.365 0.365 0.365 0.366 0.366 ...
##  $ smooth_gcc_90       : num  0.367 0.367 0.367 0.367 0.367 ...
##  $ smooth_rcc_mean     : num  0.326 0.327 0.327 0.327 0.327 ...
##  $ smooth_rcc_50       : num  0.328 0.328 0.328 0.328 0.328 ...
##  $ smooth_rcc_75       : num  0.335 0.335 0.335 0.335 0.335 ...
##  $ smooth_rcc_90       : num  0.342 0.342 0.342 0.342 0.342 ...
##  $ smooth_ci_gcc_mean  : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_gcc_50    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_gcc_75    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_gcc_90    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_rcc_mean  : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_rcc_50    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_rcc_75    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ smooth_ci_rcc_90    : num  0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 0.02 ...
##  $ int_flag            : int  1 1 1 1 1 1 1 1 1 1 ...
```

```r
str(td)
```

```
## 'data.frame':	9 obs. of  19 variables:
##  $ site                  : Factor w/ 1 level "bartlettir": 1 1 1 1 1 1 1 1 1
##  $ veg_type              : Factor w/ 1 level "DB": 1 1 1 1 1 1 1 1 1
##  $ roi_id                : int  1000 1000 1000 1000 1000 1000 1000 1000 1000
##  $ direction             : Factor w/ 2 levels "falling","rising": 2 2 2 2 2 2 2 2 2
##  $ gcc_value             : Factor w/ 4 levels "gcc_50","gcc_75",..: 3 3 3 3 3 3 3 3 3
##  $ transition_10         : Factor w/ 34 levels "2008-05-03","2008-05-04",..: 1 4 6 10 16 20 24 28 31
##  $ transition_25         : Factor w/ 28 levels "2008-05-06","2008-05-07",..: 1 4 7 12 16 19 21 24 26
##  $ transition_50         : Factor w/ 30 levels "2008-05-12","2008-09-20",..: 1 4 8 12 16 19 21 23 28
##  $ transition_10_lower_ci: Factor w/ 38 levels "2008-05-02","2008-05-03",..: 1 6 11 15 19 24 28 32 35
##  $ transition_25_lower_ci: Factor w/ 30 levels "2008-05-05","2008-05-06",..: 1 4 7 13 18 21 23 26 28
##  $ transition_50_lower_ci: Factor w/ 26 levels "2008-05-10","2008-05-11",..: 1 4 7 10 12 14 17 20 23
##  $ transition_10_upper_ci: Factor w/ 32 levels "2008-05-05","2008-05-06",..: 1 4 7 12 18 21 24 27 29
##  $ transition_25_upper_ci: Factor w/ 29 levels "2008-05-08","2008-05-09",..: 1 4 7 11 15 18 20 23 26
##  $ transition_50_upper_ci: Factor w/ 30 levels "2008-05-13","2008-09-19",..: 1 4 8 12 15 18 21 24 28
##  $ threshold_10          : num  0.378 0.376 0.377 0.377 0.376 ...
##  $ threshold_25          : num  0.392 0.389 0.392 0.394 0.391 ...
##  $ threshold_50          : num  0.427 0.42 0.425 0.423 0.426 ...
##  $ min_gcc               : num  0.37 0.366 0.369 0.367 0.365 ...
##  $ max_gcc               : num  0.476 0.472 0.478 0.478 0.477 ...
```

---
# Downloading &amp; Processing PhenoCam data


```r
# create a simple line graph 
# of the smooth Green Chromatic Coordinate (Gcc)
# and mark transition dates with vertical lines
plot(as.Date(df$date), df$smooth_gcc_90, type = "l", xlab = "Date",
     ylab = "Gcc (90th percentile)")
points(x = as.Date(td$transition_25, origin = "1970-01-01"),
       y = td$threshold_25,
       pch = 19,
       col = "red")
```

![](index_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;

---
# Downloading &amp; Processing PhenoCam data


```r
# Manually flagging of the outliers
detect_outliers("../data/bartlettir_DB_1000_3day.csv",
                out_dir = "../data/")

# Manually smoothing the data
smooth_ts("../data/bartlettir_DB_1000_3day.csv",
          out_dir = "../data/",
          force = TRUE)
```

---
# Downloading &amp; Processing PhenoCam data


```r
# Generate phenological transition dates
# for a different upper threshold (80% of amplitude)
td &lt;- phenophases(
  "../data/bartlettir_DB_1000_3day.csv",
  internal = TRUE,
  upper_thresh = 0.8)

# split out the rising (spring) component for Gcc 90th
td &lt;- td$rising[td$rising$gcc_value == "gcc_90",]
```

---
# Downloading &amp; Processing PhenoCam data


```r
# we can now visualize the upper threshold
plot(as.Date(df$date), df$smooth_gcc_90, type = "l",
     xlab = "Date",
     ylab = "Gcc (90th percentile)")
points(x = as.Date(td$transition_80, origin = "1970-01-01"),
       y = td$threshold_80,
       pch = 19,
       col = "red")
```

![](index_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;

--- 
# Downloading other data sources

- phenor specific
- covered by the **download_()** functions
- covers both phenology &amp; climate drivers

---
# Downloading PEP725 data


```r
# to list all species use
species_list &lt;- phenor::check_pep725_species(list = TRUE)

# to search only for Quercus (oak) use
quercus_nr &lt;- phenor::check_pep725_species(species = "quercus")

# return results
head(species_list)
```

```
##   number                   name
## 1    148             abies alba
## 2    115                   acer
## 3    209    actinidia deliciosa
## 4    101 aesculus hippocastanum
## 5    102                  alnus
## 6    103   alopecurus pratensis
```

```r
print(quercus_nr)
```

```
## [1] 111
```

---
# Downloading PEP725 data

- requires a login
- saved as a text file


```r
phenor::download_pep725(
  credentials = "pep725_credentials.txt",
  species = 111,
  path = ".",
  internal = FALSE
  )
```

---
# Downloading climate driver data


```r
# download source cmip5 data into
# your temporary directory
# this code is not run (large download &gt;4GB)
phenor::download_cmip5(
  year = 2090,
  path = tempdir(),
  model = "MIROC5",
  scenario = "rcp85"
  )
```

---
# Formatting phenor data

- covered by the **format_()** functions
- covers both phenology &amp; climate drivers
- used in model calibration
- used for projections (using climate drivers only)

---
# Formatting phenor data


```r
# Format the phenocam transition date data
# using the phenor formatting routine
phenocam_data &lt;- phenor::format_phenocam(
  path = "../data/",
  direction = "rising",
  gcc_value = "gcc_90",
  threshold = 50,
  offset = 264,
  internal = TRUE
  )
```

```
## Processing 1 sites
## 
  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |=================================================================| 100%
```

---
# Formatting phenor data


```
## List of 1
##  $ bartlettir:List of 13
##   ..$ site            : chr "bartlettir"
##   ..$ location        : num [1:2] 44.1 -71.3
##   ..$ doy             : int [1:365] -102 -101 -100 -99 -98 -97 -96 -95 -94 -93 ...
##   ..$ ltm             : num [1:365] 13.4 14 13.5 12.9 11.9 ...
##   ..$ transition_dates: num [1:9] 133 129 122 133 130 128 136 130 138
##   ..$ year            : num [1:9] 2008 2009 2010 2011 2012 ...
##   ..$ Ti              : num [1:365, 1:9] 16 17.2 16.8 15.5 16.2 ...
##   ..$ Tmini           : num [1:365, 1:9] 7 10 10.5 7.5 6.5 11 16 14.5 7.5 3 ...
##   ..$ Tmaxi           : num [1:365, 1:9] 25 24.5 23 23.5 26 29 28.5 24 20 18 ...
##   ..$ Li              : num [1:365, 1:9] 11.9 11.9 11.8 11.8 11.7 ...
##   ..$ Pi              : num [1:365, 1:9] 0 0 0 0 0 0 5 6 0 0 ...
##   ..$ VPDi            : num [1:365, 1:9] 1000 1240 1280 1040 960 1320 1800 1640 1040 760 ...
##   ..$ georeferencing  : NULL
##  - attr(*, "class")= chr "phenor_time_series_data"
## NULL
```

---
# Formatting phenor data


```r
# format the cmip5 data
cmip5_data &lt;- phenor::format_cmip5(
  path = tempdir(), 
  year = 2090,
  offset = 264,
  model = "MIROC5",
  scenario = "rcp85",
  extent = c(-95, -65, 24, 50),
  internal = FALSE
  )
```

---
# Model calibration


```r
# Calibrate a simple Thermal Time (TT) model
# using the included demo data (phenocam_DB)
phenocam_par &lt;- model_calibration(
  model = "TT",
  data = phenocam_DB,
  method = "GenSA",
  control = list(max.call = 4000))
```

```
## 
## Call:
## lm(formula = data$transition_dates ~ out)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -23.000  -5.637  -1.421   4.840  36.134 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  8.56056    4.51682   1.895   0.0589 .  
## out          0.92439    0.03665  25.223   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 8.68 on 356 degrees of freedom
## Multiple R-squared:  0.6412,	Adjusted R-squared:  0.6402 
## F-statistic: 636.2 on 1 and 356 DF,  p-value: &lt; 2.2e-16
```

---
# Model calibration

![](index_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;

```
## 
## Call:
## lm(formula = data$transition_dates ~ out)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -27.727  -5.600  -1.474   4.640  36.387 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  1.06660    4.93061   0.216    0.829    
## out          0.98736    0.04011  24.617   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 8.815 on 356 degrees of freedom
## Multiple R-squared:  0.6299,	Adjusted R-squared:  0.6289 
## F-statistic:   606 on 1 and 356 DF,  p-value: &lt; 2.2e-16
```

```
## $model
## [1] "TT"
## 
## $par
## [1] 181.954723  -1.194414 363.805666
## 
## $rmse
## [1] 8.805153
## 
## $rmse_null
## [1] 14.45103
## 
## $aic
## $aic$AIC
## [1] 1563.541
## 
## $aic$AICc
## [1] 1563.609
## 
## 
## $bt_output
## NULL
```

---
# Model calibration


```r
# only list the TT model parameters, ignore other
# ancillary fields
print(phenocam_par$par)
```

```
## [1] 176.967605  -2.106223 435.972684
```

---
# Model projections


```r
# read in cmip5 data
cmip5_data &lt;- readRDS("../data/phenor_cmip5_data_MIROC5_2090_rcp85.rds")

# project results forward to 2090 using the phenocam parameters
cmip5_phenocam_projection &lt;- phenor::estimate_phenology(
  par = phenocam_par$par, # provide parameters
  data = cmip5_data, # provide data
  model = "TT" # make sure to use the same model !
)
```

---
# Model projections


```r
# plot the gridded results and overlay
# a world map outline for reference
par(oma = c(0,0,0,0))
raster::plot(cmip5_phenocam_projection, main = "DOY")
maps::map("world", add = TRUE)
```

![](index_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;

---
# Reference

For more information on both packages I refer to the paper:

[Hufkens K., Basler J. D., Milliman T. Melaas E., Richardson A.D. 2018 An integrated phenology modelling framework in R: Phenology modelling with phenor. Methods in Ecology &amp; Evolution, 9: 1-10.](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.12970)

### Please use this reference whenever you use either packages!!
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
